name: Build TorchAudio Windows ARM64 Wheels
run-name: Build TorchAudio Windows ARM64 (${{ github.ref_name }})

on:
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish Release?'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*'

jobs:
  build_wheels:
    name: Build for Python ${{ matrix.python }}
    runs-on: windows-11-arm # Native Windows ARM64 runner
    strategy:
      fail-fast: false
      matrix:
        python: ["3.11", "3.12", "3.13"]

    steps:
      - name: Enable long paths
        run: git config --system core.longpaths true

      - name: Checkout TorchAudio
        uses: actions/checkout@v4
        with:
          repository: pytorch/audio
          submodules: recursive

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          architecture: arm64

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          # Explicitly install 'wheel' and 'setuptools' first to ensure bdist_wheel is available
          pip install wheel setuptools --upgrade
          pip install numpy ninja --upgrade

      - name: Install PyTorch from GitHub Release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. Use GitHub CLI to find the latest release in your pytorch-qnn repo
          # 2. Download the wheel that matches the current Python version
          $PY_TAG = "${{ matrix.python }}".Replace('.', '')
          gh release download --repo Snapdragon-AI-Stack/pytorch-qnn --pattern "*cp${PY_TAG}*" --dir .

          # 3. Install the downloaded wheel file directly
          $WHEEL_FILE = Get-ChildItem -Filter *.whl | Select-Object -First 1
          pip install $WHEEL_FILE.FullName
        
      - name: Setup FFmpeg ARM64
        # We fetch ARM64 FFmpeg headers and libs to enable the backend
        shell: pwsh
        run: |
          $FFMPEG_URL = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-winarm64-gpl-shared.zip"
          Invoke-WebRequest -Uri $FFMPEG_URL -OutFile ffmpeg.zip
          Expand-Archive ffmpeg.zip -DestinationPath ffmpeg_build
          echo "FFMPEG_ROOT=$PWD/ffmpeg_build/ffmpeg-master-latest-winarm64-gpl-shared" >> $env:GITHUB_ENV

      - name: Configure MSVC for ARM64
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: arm64

      - name: Build TorchAudio Wheel
        shell: cmd
        env:
          USE_CUDA: 0
          USE_ROCM: 0
          # Link against our custom ARM64 FFmpeg build
          BUILD_FFMPEG: 1
          FFMPEG_ROOT: ${{ env.FFMPEG_ROOT }}
        run: |
          set CMAKE_GENERATOR=Visual Studio 17 2022
          set CMAKE_GENERATOR_PLATFORM=ARM64
          
          REM Verify Numpy standalone
          python -c "import numpy; print(f'Numpy version: {numpy.__version__}')"

          REM List torch directory to see bundled DLLs
          python -c "import torch, os; print('Torch dir:', os.path.dirname(torch.__file__)); [print(f) for f in os.listdir(os.path.dirname(torch.__file__)) if f.endswith('.dll')]"

          REM Create and run a debug script to trace DLL loading and SKIP MSVC runtimes
          python -c "s = \"import ctypes\norig = ctypes.CDLL\ndef hooked_cdll(n, *a, **k):\n    print(f'DEBUG: Request to load {n}', flush=True)\n    if 'msvcp140.dll' in n or 'vcruntime140.dll' in n:\n        print(f'DEBUG: SKIPPING {n} (assuming system provided)', flush=True)\n        return None\n    return orig(n, *a, **k)\nctypes.CDLL = hooked_cdll\nimport torch\nprint(f'Torch version: {torch.__version__}')\"; open('debug_torch.py', 'w').write(s)"
          python debug_torch.py
          
          REM Use 'pip wheel' for a more robust build process than calling setup.py directly
          REM We use --no-build-isolation so it can see the 'torch' we just installed
          python -m pip wheel . --wheel-dir dist/ --no-deps --no-build-isolation

      - name: Upload Wheel Artifact
        uses: actions/upload-artifact@v4
        with:
          name: torchaudio-wheel-py${{ matrix.python }}
          path: dist/*.whl